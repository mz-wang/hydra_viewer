# .github/workflows/release.yml
#
# 自动发布流水线：构建 Python 包并通过 Trusted Publishing 发布到 PyPI
#
# ★ 本方案采用 PyPI 官方推荐的 OIDC Trusted Publishing，无需管理任何 Token/Secret。
#   原理：GitHub Actions 向 PyPI 证明"我是来自仓库 X 的合法工作流"，PyPI 信任后自动颁发
#   临时上传凭证。整个过程无需在代码或 GitHub 中存储任何密钥。
#
# 触发条件：
#   - 推送符合 "v*.*.*" 格式的 Git Tag（如 v1.0.0、v0.2.1）
#
# ─── 前置要求（一次性配置）────────────────────────────────────────────────────
#
#   步骤 1: 在 PyPI 上配置 Trusted Publisher
#     a. 登录 https://pypi.org/manage/account/publishing/
#     b. 填写以下信息，注册"待定发布者"（首次发布时会自动创建项目）：
#        - PyPI project name:     <PROJECT_NAME>
#        - GitHub owner:          <GITHUB_USERNAME>
#        - GitHub repository:     <GITHUB_REPO>
#        - Workflow filename:     release.yml
#        - GitHub environment:    pypi            ← 必须与本文件 environment.name 一致
#
#   步骤 2: 在 GitHub 仓库创建 Environment 并设置保护规则
#     a. 进入仓库 → Settings → Environments → New environment
#     b. 环境名称填: pypi
#     c. ★ 重要：开启 "Required reviewers"（手动审批）
#        这确保每次发布都需要你手动确认，防止误触发
#
# ─── 如何触发发布 ────────────────────────────────────────────────────────────
#   推荐方式（配合 Commitizen）：
#     cz bump                  # 自动分析提交历史，更新版本号，生成 CHANGELOG
#     git push --follow-tags   # 推送代码和 Tag，触发本流水线
#
#   手动方式：
#     git tag v1.0.0
#     git push origin v1.0.0
#
# ─── 官方参考文档 ─────────────────────────────────────────────────────────────
#   https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/

name: Release

on:
  push:
    tags:
      - "v*.*.*"  # 仅匹配版本号格式的 Tag

jobs:
  # ============================================================================
  # Job 1: 构建源码包（sdist）和二进制包（wheel）
  #
  # sdist: 源码压缩包（.tar.gz），用于让用户在自己机器上编译安装
  # wheel: 预编译包（.whl），安装速度快，是主要分发格式
  # ============================================================================
  build:
    name: Build distribution packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整 Git 历史（Commitizen 生成 Changelog 时需要）

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"  # 使用最新稳定版 Python

      - name: Install build frontend
        # 使用 PyPA 官方标准构建前端 `build`
        # 它会自动读取 pyproject.toml 并调用正确的构建后端（hatchling/setuptools/flit 等）
        run: python -m pip install build --user

      - name: Build sdist and wheel
        run: python -m build

      # 将 dist/ 目录中的构建产物传递给后续 Job
      # （不同 Job 之间不共享文件系统，必须通过 artifact 传递）
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

  # ============================================================================
  # Job 2: 发布到 PyPI（使用 Trusted Publishing / OIDC）
  #
  # ★ 关键：`environment` 字段必须与 PyPI 上配置的 GitHub Environment 名称完全一致
  #   正是这个绑定关系让 PyPI 知道"哪个 GitHub 环境有权限发布"
  # ============================================================================
  publish-to-pypi:
    name: Publish to PyPI
    needs: build  # 必须等 build Job 成功完成后才执行
    runs-on: ubuntu-latest

    environment:
      name: pypi
      url: https://pypi.org/p/hydra-viewer  # 替换 <PROJECT_NAME>，发布后显示为可点击链接

    permissions:
      id-token: write  # 必须：允许此 Job 向 PyPI 请求 OIDC Token

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        # 此 Action 自动检测到 OIDC 权限后，会跳过 Token 认证
        # 同时自动生成并上传 PEP 740 兼容的可信声明（attestations）
        uses: pypa/gh-action-pypi-publish@release/v1

  # ============================================================================
  # Job 3: 在 GitHub 上创建 Release 页面（可选，但推荐）
  #
  # 这会在 GitHub 仓库的 Releases 页面创建一条记录，
  # 并附上 .whl 和 .tar.gz 文件供直接下载。
  # ============================================================================
  create-github-release:
    name: Create GitHub Release
    needs: publish-to-pypi
    runs-on: ubuntu-latest

    permissions:
      contents: write  # 必须：允许创建/写入 Release 记录

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: python-package-distributions
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true  # 自动从本次 Tag 与上一 Tag 之间的提交记录生成发布说明
          files: |
            dist/*.whl
            dist/*.tar.gz
